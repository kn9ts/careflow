{
  "rules": {
    // ==========================================================================
    // WebRTC Signaling - Using Firebase UID as Primary Identifier
    // Path: /calls/{firebaseUid}/{callId}
    // Candidates sub-collection: /calls/{firebaseUid}/{callId}/candidates/{id}
    // ==========================================================================
    "calls": {
      "$firebaseUid": {
        // Users can only read/write calls under their own Firebase UID
        ".read": "auth.uid === $firebaseUid",
        ".write": "auth.uid === $firebaseUid",

        "$callId": {
          // Individual call data
          ".read": "auth.uid === $firebaseUid",
          ".write": "auth.uid === $firebaseUid || data.child('from').val() === auth.uid || data.child('to').val() === auth.uid",

          // Validate data structure for WebRTC signaling
          ".validate": "newData.hasChildren(['type', 'from', 'timestamp'])",

          "type": {
            ".validate": "newData.isString() && newData.val().matches(/^(offer|answer|candidate|hangup)$/)"
          },
          "from": {
            ".validate": "newData.isString() && (newData.val() === auth.uid || newData.val() === $firebaseUid)"
          },
          "to": {
            ".validate": "newData.isString() || newData.val() === null"
          },
          "sdp": {
            ".validate": "newData.isString() || newData.val() === null"
          },
          "candidate": {
            ".validate": "newData.isString() || newData.val() === null"
          },
          "timestamp": {
            ".validate": "newData.isNumber() && newData.val() > 0"
          },
          "status": {
            ".validate": "newData.isString() && newData.val().matches(/^(calling|ringing|connected|ended)$/) || newData.val() === null"
          },
          "reason": {
            ".validate": "newData.isString() || newData.val() === null"
          },

          // ICE Candidates sub-collection
          // Path: /calls/{firebaseUid}/{callId}/candidates/{candidateId}
          "candidates": {
            ".read": "auth.uid === $firebaseUid",
            ".write": "auth.uid !== null",

            "$candidateId": {
              ".validate": "newData.hasChildren(['type', 'from', 'candidate', 'timestamp'])",

              "type": {
                ".validate": "newData.isString() && newData.val() === 'candidate'"
              },
              "from": {
                ".validate": "newData.isString() && newData.val() === auth.uid"
              },
              "candidate": {
                // Allow object with candidate string, sdpMid, sdpMLineIndex
                ".validate": "newData.hasChildren(['candidate'])"
              },
              "timestamp": {
                ".validate": "newData.isNumber() && newData.val() > 0"
              }
            }
          }
        }
      }
    },

    // ==========================================================================
    // User Presence and Status - Using Firebase UID
    // Path: /users/{firebaseUid}
    // ==========================================================================
    "users": {
      "$firebaseUid": {
        ".read": "auth.uid === $firebaseUid",
        ".write": "auth.uid === $firebaseUid",

        "public": {
          ".read": "auth !== null",
          ".write": "auth.uid === $firebaseUid",

          "displayName": {
            ".validate": "newData.isString() && newData.val().length <= 100"
          },
          "care4wId": {
            ".validate": "newData.isString()"
          },
          "online": {
            ".validate": "newData.isBoolean()"
          },
          "lastSeen": {
            ".validate": "newData.isNumber()"
          }
        },

        "private": {
          ".read": "auth.uid === $firebaseUid",
          ".write": "auth.uid === $firebaseUid",

          "email": {
            ".validate": "newData.isString() && newData.val().matches(/^[^@]+@[^@]+$/)"
          },
          "phoneNumber": {
            ".validate": "newData.isString() || newData.val() === null"
          },
          "notificationTokens": {
            // No validation needed - just ensure it's not null or empty
          }
        }
      }
    },

    // ==========================================================================
    // Push Notification Tokens Storage
    // Path: /notificationTokens/{firebaseUid}
    // ==========================================================================
    "notificationTokens": {
      "$firebaseUid": {
        ".read": "auth.uid === $firebaseUid",
        ".write": "auth.uid === $firebaseUid",

        "$tokenId": {
          ".validate": "newData.isString() && newData.val().length > 0"
        }
      }
    },

    // ==========================================================================
    // Call History - Using Firebase UID
    // Path: /callHistory/{firebaseUid}
    // ==========================================================================
    "callHistory": {
      "$firebaseUid": {
        ".read": "auth.uid === $firebaseUid",
        ".write": "auth.uid === $firebaseUid",

        "$historyId": {
          ".validate": "newData.hasChildren(['timestamp', 'direction'])",

          "timestamp": {
            ".validate": "newData.isNumber()"
          },
          "direction": {
            ".validate": "newData.isString() && newData.val().matches(/^(inbound|outbound)$/)"
          },
          "remoteUid": {
            ".validate": "newData.isString()"
          },
          "duration": {
            ".validate": "newData.isNumber() || newData.val() === null"
          },
          "status": {
            ".validate": "newData.isString() && newData.val().matches(/^(completed|missed|rejected|failed)$/)"
          }
        }
      }
    },

    // ==========================================================================
    // Analytics - Aggregate Data (Admin Only)
    // ==========================================================================
    "analytics": {
      ".read": "auth !== null && auth.token.admin === true",
      ".write": "false"
    },

    // ==========================================================================
    // Configuration (Admin Only)
    // ==========================================================================
    "config": {
      ".read": "auth !== null && auth.token.admin === true",
      ".write": "auth !== null && auth.token.admin === true"
    }
  }
}

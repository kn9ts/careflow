[["Overview](#overview)\n2. [Architecture](#architecture)\n3. [Authentication Flow](#authentication-flow)\n4. [Making Outbound Calls](#making-outbound-calls)\n5. [Receiving Incoming Calls](#receiving-incoming-calls)\n6. [Call Recording & Storage](#call-recording--storage)\n7. [Data Models](#data-models)\n8. [API Endpoints](#api-endpoints)\n9. [Key Components](#key-components)\n10. [Security Considerations](#security-considerations)\n\n---\n\n## Overview\n\nCareFlow is a browser-based telephony application that enables users to make and receive phone calls directly from their web browser. The application integrates multiple services to provide a complete calling solution:\n\n- **Frontend:** Next.js 14 with React 18\n- **Authentication:** Firebase Authentication\n- **Voice API:** Twilio Programmable Voice\n- **Database:** MongoDB Atlas (via Mongoose)\n- **Storage:** Firebase Storage (for recordings)\n- **Notifications:** Firebase Cloud Messaging (FCM)\n\n### Key Features\n\n- Browser-based calling without additional software\n- Automatic call recording\n- Real-time call controls (mute, hangup, DTMF)\n- Call history with filtering\n- Analytics dashboard\n- Push notifications for incoming calls\n- Dark-themed responsive UI\n\n---\n\n## Architecture\n\n### High-Level Architecture\n\n```mermaid\ngraph TB\n    subgraph Client[\"Browser Client"], ["React UI]\n        AuthCtx[AuthContext]\n        TwilioSDK[Twilio Voice SDK]\n        FirebaseClient[Firebase Client SDK]\n    end\n    \n    subgraph Server[\"Next.js API Routes"], ["Auth Endpoints]\n        TokenAPI[Token Endpoint]\n        Webhooks[Twilio Webhooks]\n        AnalyticsAPI[Analytics Endpoint]\n        HistoryAPI[Call History Endpoint]\n    end\n    \n    subgraph ExternalServices[\"External Services"], ["Firebase Auth]\n        TwilioAPI[Twilio API]\n        MongoDB[MongoDB Atlas]\n        FirebaseStorage[Firebase Storage]\n        FCM[Firebase Cloud Messaging]\n    end\n    \n    UI --> AuthCtx\n    UI --> TwilioSDK\n    UI --> FirebaseClient\n    \n    AuthCtx --> AuthAPI\n    TwilioSDK --> TokenAPI\n    TwilioSDK --> TwilioAPI\n    TwilioAPI --> Webhooks\n    \n    AuthAPI --> FirebaseAuth\n    AuthAPI --> MongoDB\n    TokenAPI --> TwilioAPI\n    Webhooks --> MongoDB\n    Webhooks --> FCM\n    AnalyticsAPI --> MongoDB\n    HistoryAPI --> MongoDB\n```\n\n### Project Structure\n\n```\ncareflow/\n\u251c\u2500\u2500 app/                          # Next.js App Router\n\u2502   \u251c\u2500\u2500 api/                      # API Routes\n\u2502   \u2502   \u251c\u2500\u2500 auth/                 # Authentication endpoints\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 login/            # User login\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 logout/           # User logout\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 register/         # User registration\n\u2502   \u2502   \u251c\u2500\u2500 analytics/            # Analytics endpoint\n\u2502   \u2502   \u251c\u2500\u2500 calls/                # Call history endpoint\n\u2502   \u2502   \u251c\u2500\u2500 token/                # Twilio token generation\n\u2502   \u2502   \u251c\u2500\u2500 notifications/        # Push notification registration\n\u2502   \u2502   \u2514\u2500\u2500 webhooks/             # Twilio webhooks\n\u2502   \u2502       \u2514\u2500\u2500 twilio/\n\u2502   \u2502           \u251c\u2500\u2500 voice/        # Incoming call routing\n\u2502   \u2502           \u251c\u2500\u2500 status/       # Call status updates\n\u2502   \u2502           \u2514\u2500\u2500 voicemail/    # Voicemail handling\n\u2502   \u251c\u2500\u2500 dashboard/                # Main dashboard page\n\u2502   \u251c\u2500\u2500 login/                    # Login page\n\u2502   \u251c\u2500\u2500 signup/                   # Signup page\n\u2502   \u2514\u2500\u2500 forgot-password/          # Password reset page\n\u251c\u2500\u2500 components/                   # React components\n\u2502   \u251c\u2500\u2500 dashboard/                # Dashboard components\n\u2502   \u2502   \u251c\u2500\u2500 Analytics.js          # Analytics display\n\u2502   \u2502   \u251c\u2500\u2500 CallControls.js       # Call control buttons\n\u2502   \u2502   \u251c\u2500\u2500 CallHistory.js        # Call history list\n\u2502   \u2502   \u251c\u2500\u2500 CallStatus.js         # Call status display\n\u2502   \u2502   \u2514\u2500\u2500 DialPad.js            # Phone dial pad\n\u2502   \u251c\u2500\u2500 ProtectedRoute/           # Route protection wrapper\n\u2502   \u251c\u2500\u2500 InitializationStatus.js   # App initialization status\n\u2502   \u2514\u2500\u2500 NotificationPermission.js # Notification permission request\n\u251c\u2500\u2500 context/                      # React Context\n\u2502   \u2514\u2500\u2500 AuthContext.js            # Authentication state management\n\u251c\u2500\u2500 hooks/                        # Custom React hooks\n\u2502   \u2514\u2500\u2500 useNotifications.js       # Push notification hook\n\u251c\u2500\u2500 lib/                          # Utility libraries\n\u2502   \u251c\u2500\u2500 apiResponse.js            # API response helpers\n\u2502   \u251c\u2500\u2500 auth.js                   # Server-side auth utilities\n\u2502   \u251c\u2500\u2500 db.js                     # Database connection\n\u2502   \u251c\u2500\u2500 firebase.js               # Firebase client config\n\u2502   \u251c\u2500\u2500 firebaseConfig.js         # Firebase configuration\n\u2502   \u251c\u2500\u2500 firebaseStorage.js        # Firebase Storage utilities\n\u2502   \u251c\u2500\u2500 init.js                   # App initialization\n\u2502   \u251c\u2500\u2500 notifications.js          # Notification utilities\n\u2502   \u251c\u2500\u2500 twilio.js                 # Twilio service wrapper\n\u2502   \u2514\u2500\u2500 env.config.js             # Environment configuration\n\u2514\u2500\u2500 models/                       # Mongoose models\n    \u251c\u2500\u2500 User.js                   # User model\n    \u2514\u2500\u2500 Recording.js              # Recording model\n```\n\n---\n\n## Authentication Flow\n\nCareFlow uses Firebase Authentication as the primary identity provider, with MongoDB storing additional user metadata.\n\n### Authentication Sequence\n\n```mermaid\nsequenceDiagram\n    participant User\n    participant AuthCtx as AuthContext\n    participant Firebase as Firebase Auth\n    participant API as Next.js API\n    participant MongoDB as MongoDB\n\n    User->>AuthCtx: login(email, password)\n    AuthCtx->>Firebase: signInWithEmailAndPassword()\n    Firebase-->>AuthCtx: User credential\n    AuthCtx->>API: POST /api/auth/login\n    API->>Firebase: Verify token\n    API->>MongoDB: getOrCreateUser()\n    MongoDB-->>API: User document\n    API-->>AuthCtx: User data + twilioClientIdentity\n    AuthCtx->>AuthCtx: Set token (auto-refresh every 50 min)\n    AuthCtx-->>User: Login success\n```\n\n### How Authentication Works\n\n1. **User Login** ([`app/login/page.js`](careflow/app/login/page.js:1))\n   - User enters email and password\n   - [`AuthContext.login()`](careflow/context/AuthContext.js:121) calls Firebase's `signInWithEmailAndPassword()`\n   - Firebase validates credentials and returns user object\n\n2. **Server Verification** ([`app/api/auth/login/route.js`](careflow/app/api/auth/login/route.js:1))\n   - Client sends Firebase ID token to `/api/auth/login`\n   - Server verifies token with Firebase Admin SDK\n   - Server calls [`getOrCreateUser()`](careflow/lib/auth.js:1) to ensure user exists in MongoDB\n\n3. **User Creation in MongoDB** ([`models/User.js`](careflow/models/User.js:1))\n   - If user doesn't exist, creates new User document\n   - Generates unique `twilioClientIdentity` for Twilio integration\n   - Stores user profile, role, and notification preferences\n\n4. **Token Management** ([`context/AuthContext.js`](careflow/context/AuthContext.js:1))\n   - Firebase ID token stored in AuthContext\n   - Auto-refresh every 50 minutes (tokens expire in 60 minutes)\n   - If refresh fails, user is automatically logged out\n\n5. **Protected Routes** ([`components/ProtectedRoute/ProtectedRoute.js`](careflow/components/ProtectedRoute/ProtectedRoute.js:1))\n   - All dashboard pages wrapped in ProtectedRoute component\n   - Redirects to login if user not authenticated\n\n### User Model\n\nThe [`User`](careflow/models/User.js:1) model stores:\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `firebaseUid` | String | Firebase Auth user ID (unique, indexed) |\n| `email` | String | User email (unique, lowercase) |\n| `displayName` | String | User display name |\n| `photoURL` | String | Profile photo URL |\n| `role` | String | \"user\" or \"admin\" |\n| `isActive` | Boolean | Account active status |\n| `twilioPhoneNumber` | String | Assigned Twilio phone number |\n| `twilioClientIdentity` | String | Unique identity for Twilio client |\n| `notifications` | Object | Notification preferences |\n| `notificationTokens` | Array | FCM push notification tokens |\n| `storageUsed` | Number | Storage quota used (bytes) |\n| `storageLimit` | Number | Storage quota limit (default 1GB) |\n\n---\n\n## Making Outbound Calls\n\n### Outbound Call Flow\n\n```mermaid\nsequenceDiagram\n    participant User\n    participant Dashboard as Dashboard Page\n    participant TwilioSDK as Twilio Device SDK\n    participant TokenAPI as /api/token\n    participant TwilioAPI as Twilio API\n    participant Webhook as /api/webhooks/twilio/status\n    participant MongoDB as MongoDB\n\n    User->>Dashboard: Enter phone number\n    Dashboard->>TokenAPI: GET /api/token (with auth token)\n    TokenAPI->>TwilioAPI: Generate JWT with VoiceGrant\n    TwilioAPI-->>TokenAPI: JWT token\n    TokenAPI-->>Dashboard: Twilio access token\n    Dashboard->>TwilioSDK: Initialize Device with token\n    TwilioSDK-->>Dashboard: Device ready\n    User->>Dashboard: Click \"Call\"\n    Dashboard->>TwilioSDK: device.connect({ To: phoneNumber })\n    TwilioSDK->>TwilioAPI: Initiate call\n    TwilioAPI-->>TwilioSDK: Call connected\n    TwilioSDK-->>Dashboard: \"connect\" event\n    Dashboard->>Dashboard: Start call timer\n    Note over TwilioSDK: Call in progress...\n    User->>Dashboard: Click \"Hangup", "Dashboard->>TwilioSDK: connection.disconnect()\n    TwilioSDK->>TwilioAPI: End call\n    TwilioAPI->>Webhook: POST status webhook\n    Webhook->>MongoDB: Create/update Recording\n    Webhook-->>Dashboard: Call history updated\n```\n\n### How Outbound Calls Work\n\n1. **Token Generation** ([`app/api/token/route.js`](careflow/app/api/token/route.js:1))\n   - Client requests Twilio access token from `/api/token`\n   - Server validates user authentication\n   - Server generates JWT with `VoiceGrant` containing:\n     - `outgoingApplicationSid`: TwiML App SID\n     - `incomingAllow: true`: Allows receiving calls\n     - `identity`: User's `twilioClientIdentity`\n\n2. **Device Initialization** ([`app/dashboard/page.js:58-108`](careflow/app/dashboard/page.js:58))\n   - Dashboard calls [`initializeTwilioDevice()`](careflow/app/dashboard/page.js:58)\n   - Creates new [`Device`](careflow/app/dashboard/page.js:69) from Twilio SDK\n   - Configures codec preferences (opus, pcmu)\n   - Sets up event listeners for device states\n\n3. **Making the Call** ([`app/dashboard/page.js:124-134`](careflow/app/dashboard/page.js:124))\n   - User enters phone number and clicks \"Call", ["makeCall()`](careflow/app/dashboard/page.js:124) calls `device.connect({ To: phoneNumber })`\n   - Twilio Device initiates call to Twilio API\n   - Call status changes to \"connecting", 4.0, "Call Connected** ([`app/dashboard/page.js:85-89`](careflow/app/dashboard/page.js:85))\n   - On \"connect", "event, connection object is stored\n   - Call status changes to \"connected", ["startCallTimer()`](careflow/app/dashboard/page.js:111) begins tracking duration\n\n5. **Call Controls** ([`app/dashboard/page.js:136-175`](careflow/app/dashboard/page.js:136))\n   - **Hangup:** [`hangupCall()`](careflow/app/dashboard/page.js:136) disconnects the connection\n   - **Mute:** [`toggleMute()`](careflow/app/dashboard/page.js:161) toggles microphone\n   - **DTMF:** [`sendDigits()`](careflow app/dashboard/page.js:168) sends touch tones\n\n6. **Call Completion** ([`app/api/webhooks/twilio/status/route.js:32-58`](careflow/app/api/webhooks/twilio/status/route.js:32))\n   - Twilio sends status webhook when call completes\n   - Server creates [`Recording`](careflow/models/Recording.js:1) document in MongoDB\n   - Stores call details: duration, participants, direction, recording URL\n\n---\n\n## Receiving Incoming Calls\n\n### Incoming Call Flow\n\n```mermaid\nsequenceDiagram\n    participant Caller as External Caller\n    participant TwilioAPI as Twilio API\n    participant VoiceWebhook as /api/webhooks/twilio/voice\n    participant MongoDB as MongoDB\n    participant FCM as Firebase Cloud Messaging\n    participant Browser as User Browser\n    participant TwilioSDK as Twilio Device SDK\n    participant Dashboard as Dashboard\n\n    Caller->>TwilioAPI: Calls Twilio phone number\n    TwilioAPI->>VoiceWebhook: POST webhook (From, To, CallSid)\n    VoiceWebhook->>MongoDB: Find user by twilioPhoneNumber\n    MongoDB-->>VoiceWebhook: User document\n    VoiceWebhook->>FCM: Send push notification\n    VoiceWebhook-->>TwilioAPI: TwiML response (dial.client)\n    TwilioAPI->>Browser: Ring browser client\n    TwilioSDK->>Dashboard: \"incoming\" event\n    Dashboard->>Dashboard: Show incoming call UI\n    User->>Dashboard: Click \"Accept\"\n    Dashboard->>TwilioSDK: connection.accept()\n    TwilioSDK->>TwilioAPI: Accept call\n    TwilioAPI-->>TwilioSDK: Call connected\n    TwilioSDK-->>Dashboard: \"connect\" event\n    Note over TwilioSDK: Call in progress...\n    User->>Dashboard: Click \"Hangup", "Dashboard->>TwilioSDK: connection.disconnect()\n    TwilioAPI->>VoiceWebhook: POST status webhook\n    VoiceWebhook->>MongoDB: Create Recording\n```\n\n### How Incoming Calls Work\n\n1. **Incoming Call Received** ([`app/api/webhooks/twilio/voice/route.js:7-36`](careflow/app/api/webhooks/twilio/voice/route.js:7))\n   - External caller dials the Twilio phone number\n   - Twilio sends webhook to `/api/webhooks/twilio/voice`\n   - Webhook contains: `From`, `To`, `CallSid`, `CallStatus`\n\n2. **User Lookup** ([`app/api/webhooks/twilio/voice/route.js:24`](careflow/app/api/webhooks/twilio/voice/route.js:24))\n   - Server queries MongoDB for user with matching `twilioPhoneNumber`\n   - If no user found, returns error TwiML response\n\n3. **Push Notification** ([`app/api/webhooks/twilio/voice/route.js:40-48`](careflow/app/api/webhooks/twilio/voice/route.js:40))\n   - Server calls [`sendIncomingCallNotification()`](careflow/lib/notifications.js:1)\n   - Sends FCM push notification to user's registered devices\n   - Notification includes call details (caller, call SID)\n\n4. **TwiML Response** ([`app/api/webhooks/twilio/voice/route.js:50-64`](careflow/app/api/webhooks/twilio/voice/route.js:50))\n   - Server generates TwiML using [`VoiceResponse`](careflow/app/api/webhooks/twilio/voice/route.js:2)\n   - Includes \"Connecting your call", "message\n   - Uses `dial.client(user.twilioClientIdentity)` to route to browser\n\n5. **Browser Receives Call** ([`app/dashboard/page.js:98-102`](careflow/app/dashboard/page.js:98))\n   - Twilio Device SDK emits \"incoming", "event\n   - Dashboard displays incoming call UI with caller number\n   - User can accept or reject the call\n\n6. **Accepting the Call** ([`app/dashboard/page.js:146-152`](careflow/app/dashboard/page.js:146))\n   - User clicks \"Accept", ["acceptCall()`](careflow/app/dashboard/page.js:146) calls `connection.accept()`\n   - Call is established and timer starts\n\n7. **Rejecting the Call** ([`app/dashboard/page.js:154-159`](careflow/app/dashboard/page.js:154))\n   - User clicks \"Reject", ["rejectCall()`](careflow/app/dashboard/page.js:154) calls `connection.reject()`\n   - Call is declined and status webhook sent\n\n---\n\n## Call Recording & Storage\n\n### Recording Flow\n\n```mermaid\nsequenceDiagram\n    participant TwilioAPI as Twilio API\n    participant StatusWebhook as /api/webhooks/twilio/status\n    participant MongoDB as MongoDB\n    participant Dashboard as Dashboard\n    participant HistoryAPI as /api/calls/history\n\n    Note over TwilioAPI: Call in progress...\n    TwilioAPI->>TwilioAPI: Record call audio\n    Note over TwilioAPI: Call ends\n    TwilioAPI->>StatusWebhook: POST status webhook\n    StatusWebhook->>StatusWebhook: Check if Recording exists\n    alt Recording exists\n        StatusWebhook->>MongoDB: Update Recording (duration, status)\n    else Recording doesn't exist\n        StatusWebhook->>MongoDB: Create new Recording\n    end\n    StatusWebhook-->>TwilioAPI: 200 OK\n    Dashboard->>HistoryAPI: GET /api/calls/history\n    HistoryAPI->>MongoDB: Query Recordings by userId\n    MongoDB-->>HistoryAPI: Recording documents\n    HistoryAPI-->>Dashboard: Call history data\n    Dashboard->>Dashboard: Display call history\n```\n\n### How Recording Works\n\n1. **Automatic Recording**\n   - Twilio automatically records all calls (configured in TwiML App)\n   - Recording URL included in status webhook\n\n2. **Recording Storage** ([`app/api/webhooks/twilio/status/route.js:32-58`](careflow/app/api/webhooks/twilio/status/route.js:32))\n   - On call completion, status webhook received\n   - Server checks if [`Recording`](careflow/models/Recording.js:1) document exists\n   - If exists: updates duration and status\n   - If doesn't exist: creates new Recording document\n\n3. **Recording Model** ([`models/Recording.js`](careflow/models/Recording.js:1))\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `userId` | ObjectId | Reference to User |\n| `firebaseUid` | String | Firebase user ID (indexed) |\n| `type` | String | \"call\" or \"voicemail\" |\n| `sid` | String | Unique recording SID |\n| `callSid` | String | Associated call SID |\n| `from` | String | Caller phone number |\n| `to` | String | Recipient phone number |\n| `direction` | String | \"inbound\" or \"outbound\" |\n| `s3Key` | String | Storage key (currently uses \"twilio\" bucket) |\n| `s3Bucket` | String | Storage bucket name |\n| `duration` | Number | Call duration in seconds |\n| `fileSize` | Number | Recording file size in bytes |\n| `format` | String | Audio format (default: \"wav\") |\n| `recordedAt` | Date | When recording was made |\n| `uploadedAt` | Date | When recording was uploaded |\n| `status` | String | \"active", "archived", "or \"deleted\" |\n| `storageClass` | String | \"STANDARD\" or \"GLACIER_DEEP_ARCHIVE", "isListened` | Boolean | Whether recording has been played |\n| `transcription` | String | Optional transcription text |\n| `callerLocation` | String | Optional caller location |\n\n4. **Call History** ([`app/api/calls/history/route.js`](careflow/app/api/calls/history/route.js:1))\n   - Client requests call history from `/api/calls/history`\n   - Server queries MongoDB for user's recordings\n   - Returns paginated list with filtering options\n\n5. **Analytics** ([`app/api/analytics/route.js`](careflow/app/api/analytics/route.js:1))\n   - Calculates call statistics from recordings\n   - Returns: total calls, total duration, success rate, today's calls\n\n---\n\n## Data Models\n\n### User Model\n\nThe [`User`](careflow/models/User.js:1) model represents application users:\n\n```javascript\n{\n  firebaseUid: String,           // Firebase Auth user ID\n  email: String,                 // User email (unique)\n  displayName: String,           // Display name\n  photoURL: String,              // Profile photo URL\n  role: String,                  // \"user\" or \"admin", "isActive: Boolean,             // Account active status\n  twilioPhoneNumber: String,     // Assigned Twilio number\n  twilioClientIdentity: String,  // Unique Twilio client identity\n  notifications: {\n    incomingCalls: Boolean,\n    missedCalls: Boolean,\n    voicemails: Boolean,\n    email: Boolean\n  },\n  notificationTokens: [{\n    token: String,\n    deviceInfo: {\n      userAgent: String,\n      platform: String,\n      language: String\n    },\n    registeredAt: Date\n  }],\n  storageUsed: Number,           // Bytes used\n  storageLimit: Number,          // Bytes allowed (default 1GB)\n  lastLoginAt: Date,\n  createdAt: Date,\n  updatedAt: Date\n}\n```\n\n### Recording Model\n\nThe [`Recording`](careflow/models/Recording.js:1) model stores call recordings:\n\n```javascript\n{\n  userId: ObjectId,              // Reference to User\n  firebaseUid: String,           // Firebase user ID\n  type: String,                  // \"call\" or \"voicemail", "sid: String,                   // Unique recording SID\n  callSid: String,               // Associated call SID\n  from: String,                  // Caller phone number\n  to: String,                    // Recipient phone number\n  direction: String,             // \"inbound\" or \"outbound", "s3Key: String,                 // Storage key\n  s3Bucket: String,              // Storage bucket\n  duration: Number,              // Duration in seconds\n  fileSize: Number,              // File size in bytes\n  format: String,                // Audio format\n  recordedAt: Date,              // Recording timestamp\n  uploadedAt: Date,              // Upload timestamp\n  listenedAt: Date,              // First listen timestamp\n  archivedAt: Date,              // Archive timestamp\n  status: String,                // \"active", "archived", "deleted", "storageClass: String,          // \"STANDARD\" or \"GLACIER_DEEP_ARCHIVE", "isListened: Boolean,           // Whether played\n  transcription: String,         // Optional transcription\n  callerLocation: String         // Optional location\n}\n```\n\n---\n\n## API Endpoints\n\n### Authentication Endpoints\n\n| Endpoint | Method | Description | Request Body | Response |\n|----------|--------|-------------|--------------|----------|\n| `/api/auth/login` | POST | User login | `{ email, password }` | `{ user, message }` |\n| `/api/auth/register` | POST | User registration | `{ email, password, displayName }` | `{ user, message }` |\n| `/api/auth/logout` | POST | User logout | - | `{ message }` |\n\n### Twilio Endpoints\n\n| Endpoint | Method | Description | Headers | Response |\n|----------|--------|-------------|---------|----------|\n| `/api/token` | GET | Generate Twilio access token | `Authorization: Bearer <token>` | `{ token, identity }` |\n\n### Webhook Endpoints\n\n| Endpoint | Method | Description | Source | Response |\n|----------|--------|-------------|--------|----------|\n| `/api/webhooks/twilio/voice` | POST | Handle incoming calls | Twilio | TwiML XML |\n| `/api/webhooks/twilio/status` | POST | Handle call status updates | Twilio | `{ message }` |\n| `/api/webhooks/twilio/voicemail` | POST | Handle voicemail | Twilio | `{ message }` |\n\n### Data Endpoints\n\n| Endpoint | Method | Description | Headers | Response |\n|----------|--------|-------------|---------|----------|\n| `/api/calls/history` | GET | Get call history | `Authorization: Bearer <token>` | `{ calls, pagination }` |\n| `/api/analytics` | GET | Get call analytics | `Authorization: Bearer <token>` | `{ analytics }` |\n\n### Notification Endpoints\n\n| Endpoint | Method | Description | Request Body | Response |\n|----------|--------|-------------|--------------|----------|\n| `/api/notifications/register` | POST | Register FCM token | `{ token, deviceInfo }` | `{ message }` |\n\n---\n\n## Key Components\n\n### AuthContext ([`context/AuthContext.js`](careflow/context/AuthContext.js:1))\n\nThe [`AuthContext`](careflow/context/AuthContext.js:1) provides authentication state management:\n\n- **State:** `currentUser`, `token`, `loading`, `error`\n- **Methods:** `login()`, `signup()`, `logout()`, `resetPassword()`, `updateProfileData()`\n- **Auto-refresh:** Token refreshes every 50 minutes\n- **Error handling:** Maps Firebase error codes to user-friendly messages\n\n### Dashboard Page ([`app/dashboard/page.js`](careflow/app/dashboard/page.js:1))\n\nThe main dashboard with three tabs:\n\n**Dialer Tab:**\n- Phone number input with dial pad\n- Call status display\n- Call controls (make, hangup, accept, reject, mute)\n- Quick stats display\n\n**History Tab:**\n- Paginated call history list\n- Filtering by type (all, incoming, outgoing, missed)\n- Sorting by date, caller, duration, status\n\n**Analytics Tab:**\n- Total calls count\n- Total voicemails count\n- Total duration\n- Success rate\n- Today's calls\n- Average call duration\n- Recent calls list\n\n### Twilio Service ([`lib/twilio.js`](careflow/lib/twilio.js:1))\n\nA wrapper class for Twilio Device SDK (currently unused in dashboard):\n\n- **Methods:** `initialize()`, `connect()`, `disconnect()`, `mute()`, `sendDigits()`, `destroy()`\n- **Event handling:** Custom event emitter pattern\n- **Note:** This service is defined but not actively used in the current implementation\n\n### Notification Hook ([`hooks/useNotifications.js`](careflow/hooks/useNotifications.js:1))\n\nCustom hook for push notifications:\n\n- **FCM registration:** Registers device token with server\n- **Incoming call handling:** Handles incoming call notifications\n- **Token management:** Registers/unregisters tokens on login/logout\n\n### Protected Route ([`components/ProtectedRoute/ProtectedRoute.js`](careflow/components/ProtectedRoute/ProtectedRoute.js:1))\n\nRoute protection wrapper:\n\n- Checks authentication status\n- Redirects to login if not authenticated\n- Shows loading state during auth check\n\n---\n\n## Security Considerations\n\n### Current Security Measures\n\n1. **Firebase Authentication**\n   - Secure token-based authentication\n   - Automatic token refresh\n   - Built-in password security\n\n2. **Protected API Routes**\n   - All API endpoints require valid Firebase token\n   - Server-side token verification with Firebase Admin SDK\n\n3. **Environment Variables**\n   - Sensitive credentials stored in environment variables\n   - Never exposed to client-side code\n\n4. **Route Protection**\n   - Dashboard pages wrapped in ProtectedRoute component\n   - Automatic redirect to login for unauthenticated users\n\n### Security Vulnerabilities\n\n| Vulnerability | Severity | Mitigation |\n|---------------|----------|------------|\n| No webhook signature verification | High | Verify Twilio webhook signatures |\n| No rate limiting | High | Implement rate limiting on API endpoints |\n| No input sanitization | Medium | Implement comprehensive input validation |\n| localStorage for tokens | Medium | Consider httpOnly cookies |\n| No CSRF protection | High | Add CSRF tokens |\n| Missing CSP headers | Medium | Implement Content Security Policy |\n| No audit logging | Medium | Implement audit logging for sensitive actions |\n\n### Recommended Security Enhancements\n\n1. Implement webhook signature verification for Twilio webhooks\n2. Add rate limiting to all API endpoints\n3. Implement comprehensive input validation and sanitization\n4. Add Content Security Policy headers\n5. Implement CSRF protection\n6. Add audit logging for all sensitive operations\n7. Strengthen password requirements\n8. Implement session timeout and invalidation\n9. Add security headers (HSTS, X-Frame-Options, etc.)\n10. Regular security audits and dependency updates\n\n---\n\n## Summary\n\nCareFlow is a comprehensive browser-based telephony application that:\n\n1. **Authenticates users** using Firebase Authentication with MongoDB for additional metadata\n2. **Generates Twilio tokens** with VoiceGrant for browser-based calling\n3. **Makes outbound calls** through Twilio Programmable Voice API\n4. **Receives incoming calls** via Twilio webhooks and push notifications\n5. **Records calls** automatically and stores metadata in MongoDB\n6. **Displays call history** with filtering and pagination\n7. **Shows analytics** with call statistics and metrics\n8. **Manages notifications** through Firebase Cloud Messaging\n\nThe application follows a modern architecture with clear separation of concerns between frontend, backend, and external services. All API endpoints are protected with Firebase authentication, and call data is securely stored in MongoDB with proper indexing for efficient queries."]]]]]]
